<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Gyron</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .initial-view.hidden, .ready-view.hidden {
            display: none;
        }
        h1 {
            font-size: 1.8rem;
            color: #111827;
        }
        p {
            color: #4b5563;
            margin-bottom: 1.5rem;
        }
        .input-group {
            margin-bottom: 1rem;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        input[type="url"], input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .button {
            background-color: #007bff;
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .ready-view h2 {
            color: #16a34a; /* Green */
            font-size: 1.5rem;
        }
        .icon-selection {
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: left;
        }
        .icon-selection label {
            margin-bottom: 0.75rem;
            display: block;
            font-weight: 500;
            color: #374151;
        }
        .icon-grid {
            display: flex;
            gap: 0.5rem;
        }
        .icon-btn {
            border: 2px solid #d1d5db;
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            font-size: 1.5rem; /* Emoji size */
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .icon-btn.selected {
            border-color: #007bff;
            background-color: #e0efff;
        }
        #customIconInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- State 1: Initial View -->
        <div class="initial-view">
            <h1>Project Gyron</h1>
            <p>Create a persistent web app from any URL</p>

            <div class="input-group">
                <label for="appName">App Name:</label>
                <input type="text" id="appName" placeholder="e.g., My Mail App">
            </div>
            <div class="input-group">
                <label for="appUrl">Enter URL:</label>
                <input type="url" id="appUrl" placeholder="https://example.com" required>
            </div>


            <button class="button" id="createAppBtn">Create App</button>
        </div>

        <!-- State 2: Ready to Install View -->
        <div class="ready-view hidden">
            <h2>âœ… App Ready to Install!</h2>
            <p>Your app will be installed using this browser's profile, preserving your logins and cookies.</p>
            <button class="button" id="installAppBtn">Install App</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const initialView = document.querySelector('.initial-view');
            const readyView = document.querySelector('.ready-view');
            const createAppBtn = document.getElementById('createAppBtn');
            const installAppBtn = document.getElementById('installAppBtn');
            const appNameInput = document.getElementById('appName');
            const appUrlInput = document.getElementById('appUrl');
            let deferredPrompt;

            function generateIcon(appName) {
                const size = 144;
                const char = appName ? appName.charAt(0).toUpperCase() : 'ðŸ”§';
                const isEmoji = !appName;

                const svg = `
                    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#003f5c;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#58508d;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect width="${size}" height="${size}" fill="url(#grad1)"/>
                        <text x="50%" y="50%" dominant-baseline="central" text-anchor="middle"
                              font-family="Arial, sans-serif" font-size="${isEmoji ? size * 0.6 : size * 0.5}"
                              font-weight="bold" fill="white">
                            ${char}
                        </text>
                    </svg>
                `;
                return `data:image/svg+xml,${encodeURIComponent(svg)}`;
            }

            const serviceWorkerCode = `
              let appName = 'PWA';
              let appUrl = '/';
              let iconUrl;

              self.addEventListener('message', event => {
                  if (event.data.type === 'REGISTER_PWA') {
                      appName = event.data.appName;
                      appUrl = event.data.appUrl;
                      iconUrl = event.data.iconUrl;
                  }
              });

              self.addEventListener('fetch', event => {
                  if (new URL(event.request.url).pathname === '/manifest.json') {
                      const manifest = {
                          name: appName,
                          short_name: appName,
                          start_url: appUrl,
                          display: 'standalone',
                          background_color: '#ffffff',
                          theme_color: '#000000',
                          icons: [
                              {
                                  src: iconUrl,
                                  sizes: '144x144',
                                  type: 'image/svg+xml'
                              }
                          ]
                      };
                      event.respondWith(
                          new Response(JSON.stringify(manifest), {
                              headers: { 'Content-Type': 'application/json' }
                          })
                      );
                  }
              });
            `;

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installAppBtn.disabled = false;
                readyView.querySelector('p').textContent = "Your app will be installed using this browser's profile, preserving your logins and cookies.";
            });

            createAppBtn.addEventListener('click', async () => {
                const appName = appNameInput.value.trim();
                const appUrl = appUrlInput.value.trim();

                if (!appName || !appUrl) {
                    alert('Please provide both an App Name and a URL.');
                    return;
                }

                initialView.classList.add('hidden');
                readyView.classList.remove('hidden');
                installAppBtn.textContent = 'Install "' + appName + '"';
                installAppBtn.disabled = true;
                readyView.querySelector('p').textContent = "Preparing your app... The install button will enable shortly.";

                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for(let registration of registrations) {
                        await registration.unregister();
                    }

                    const blob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);
                    const registration = await navigator.serviceWorker.register(swUrl);

                    await navigator.serviceWorker.ready;

                    if (registration.active) {
                        const iconUrl = generateIcon(appName);
                        registration.active.postMessage({
                            type: 'REGISTER_PWA',
                            appName,
                            appUrl,
                            iconUrl: iconUrl
                        });
                    }
                } catch (error) {
                    console.error('Error during PWA creation:', error);
                    alert('Failed to create the app. Please ensure your browser supports this feature and you are not in private mode.');
                    readyView.classList.add('hidden');
                    initialView.classList.remove('hidden');
                }
            });

            installAppBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    await deferredPrompt.userChoice;
                    deferredPrompt = null;
                }
            });
        });
    </script>

</body>
</html>
