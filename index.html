<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Gyron</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .initial-view.hidden, .ready-view.hidden {
            display: none;
        }
        h1 {
            font-size: 1.8rem;
            color: #111827;
        }
        p {
            color: #4b5563;
            margin-bottom: 1.5rem;
        }
        .input-group {
            margin-bottom: 1rem;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        input[type="url"], input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .button {
            background-color: #007bff;
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .ready-view h2 {
            color: #16a34a; /* Green */
            font-size: 1.5rem;
        }
        .icon-selection {
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: left;
        }
        .icon-selection label {
            margin-bottom: 0.75rem;
            display: block;
            font-weight: 500;
            color: #374151;
        }
        .icon-grid {
            display: flex;
            gap: 0.5rem;
        }
        .icon-btn {
            border: 2px solid #d1d5db;
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            font-size: 1.5rem; /* Emoji size */
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .icon-btn.selected {
            border-color: #007bff;
            background-color: #e0efff;
        }
        #customIconInput {
            display: none;
        }
    </style>
</head>
<body>
    <div id="svg-icon-container" style="display: none;">
        <svg id="icon-globe" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 -960 960 960"><path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm-43-61v-82q-35 0-59-26t-24-61v-44L149-559q-5 20-7 39.5t-2 39.5q0 130 84.5 227T437-141Zm294-108q44-48 66.5-107.5T820-480q0-106-58-192.5T607-799v18q0 35-24 61t-59 26h-87v87q0 17-13.5 28T393-568h-83v88h258q17 0 28 13t11 30v127h43q29 0 51 17t30 44Z"/></svg>
        <svg id="icon-settings" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 -960 960 960"><path d="m388-80-20-126q-19-7-40-19t-37-25l-118 54-93-164 108-79q-2-9-2.5-20.5T185-480q0-9 .5-20.5T188-521L80-600l93-164 118 54q16-13 37-25t40-18l20-127h184l20 126q19 7 40.5 18.5T669-710l118-54 93 164-108 77q2 10 2.5 21.5t.5 21.5q0 10-.5 21t-2.5 21l108 78-93 164-118-54q-16 13-36.5 25.5T592-206L572-80H388Zm48-60h88l14-112q33-8 62.5-25t53.5-41l106 46 40-72-94-69q4-17 6.5-33.5T715-480q0-17-2-33.5t-7-33.5l94-69-40-72-106 46q-23-26-52-43.5T538-708l-14-112h-88l-14 112q-34 7-63.5 24T306-642l-106-46-40 72 94 69q-4 17-6.5 33.5T245-480q0 17 2.5 33.5T254-413l-94 69 40 72 106-46q24 24 53.5 41t62.5 25l14 112Zm44-210q54 0 92-38t38-92q0-54-38-92t-92-38q-54 0-92 38t-38 92q0 54 38 92t92 38Zm0-130Z"/></svg>
        <svg id="icon-cloud" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 -960 960 960"><path d="M251-160q-88 0-149.5-61.5T40-371q0-78 50-137t127-71q20-97 94-158.5T482-799q112 0 189 81.5T748-522v24q72-2 122 46.5T920-329q0 69-50 119t-119 50H251Zm0-60h500q45 0 77-32t32-77q0-45-32-77t-77-32h-63v-84q0-91-61-154t-149-63q-88 0-149.5 63T267-522h-19q-62 0-105 43.5T100-371q0 63 44 107t107 44Zm229-260Z"/></svg>
        <svg id="icon-work" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 -960 960 960"><path d="M140-120q-24 0-42-18t-18-42v-480q0-24 18-42t42-18h180v-100q0-24 18-42t42-18h200q24 0 42 18t18 42v100h180q24 0 42 18t18 42v480q0 24-18 42t-42 18H140Zm0-60h680v-480H140v480Zm240-540h200v-100H380v100ZM140-180v-480 480Z"/></svg>
        <svg id="icon-star" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 -960 960 960"><path d="m323-245 157-94 157 95-42-178 138-120-182-16-71-168-71 167-182 16 138 120-42 178Zm-90 125 65-281L80-590l288-25 112-265 112 265 288 25-218 189 65 281-247-149-247 149Zm247-355Z"/></svg>
    </div>
    <div class="container">
        <!-- State 1: Initial View -->
        <div class="initial-view">
            <h1>Project Gyron</h1>
            <p>Create a persistent web app from any URL</p>

            <div class="input-group">
                <label for="appName">App Name:</label>
                <input type="text" id="appName" placeholder="e.g., My Mail App">
            </div>
            <div class="input-group">
                <label for="appUrl">Enter URL:</label>
                <input type="url" id="appUrl" placeholder="https://example.com" required>
            </div>

            <div class="icon-selection">
                <label>Select an Icon:</label>
                <div class="icon-grid">
                    <!-- Icons will be populated by JS -->
                </div>
                <input type="file" id="customIconInput" accept="image/png, image/jpeg">
            </div>

            <button class="button" id="createAppBtn">Create App</button>
        </div>

        <!-- State 2: Ready to Install View -->
        <div class="ready-view hidden">
            <h2>âœ… App Ready to Install!</h2>
            <p>Your app will be installed using this browser's profile, preserving your logins and cookies.</p>
            <button class="button" id="installAppBtn">Install App</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            renderIcons();
            const initialView = document.querySelector('.initial-view');
            const readyView = document.querySelector('.ready-view');
            const createAppBtn = document.getElementById('createAppBtn');
            const installAppBtn = document.getElementById('installAppBtn');
            const appNameInput = document.getElementById('appName');
            const appUrlInput = document.getElementById('appUrl');
            const iconGrid = document.querySelector('.icon-grid');
            const customIconInput = document.getElementById('customIconInput');
            let deferredPrompt;
            let selectedIconUrl = null;

            function renderIcons() {
                const svgContainer = document.getElementById('svg-icon-container');
                const icons = svgContainer.querySelectorAll('svg');

                icons.forEach(icon => {
                    const btn = document.createElement('button');
                    btn.className = 'icon-btn';
                    btn.appendChild(icon.cloneNode(true));
                    btn.addEventListener('click', () => {
                        const iconSvg = icon.outerHTML;
                        selectIcon(btn, iconSvg);
                    });
                    iconGrid.appendChild(btn);
                });

                const customBtn = document.createElement('button');
                customBtn.className = 'icon-btn';
                customBtn.textContent = 'Custom';
                customBtn.id = 'customIconBtn';
                customBtn.addEventListener('click', () => customIconInput.click());
                iconGrid.appendChild(customBtn);
            }

            function selectIcon(button, url) {
                document.querySelectorAll('.icon-btn').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                selectedIconUrl = url;
            }

            customIconInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const customIconDataUrl = e.target.result;
                    selectIcon(document.getElementById('customIconBtn'), customIconDataUrl);
                };
                reader.readAsDataURL(file);
            });

            const serviceWorkerCode = `
              let appName = 'PWA';
              let appUrl = '/';
              let iconUrl;

              self.addEventListener('message', event => {
                  if (event.data.type === 'REGISTER_PWA') {
                      appName = event.data.appName;
                      appUrl = event.data.appUrl;
                      iconUrl = event.data.iconUrl;
                  }
              });

              self.addEventListener('fetch', event => {
                  if (new URL(event.request.url).pathname === '/manifest.json') {
                      const iconSrc = iconUrl ? `data:image/svg+xml,${encodeURIComponent(iconUrl)}` : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIBAMAAABfdrOtAAAAG1BMVEX///8AAAB2dnbq6uqtra1+fn7MzMxgYGAzMzO8FNIZAAAAAXRSTlMAQObYZgAAAFdJREFUeNrtwQENAAAAwqD3T20PBxQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAeQEJAAABQY0iYAAAAABJRU5ErkJggg==';
                      const iconType = iconUrl ? 'image/svg+xml' : 'image/png';

                      const manifest = {
                          name: appName,
                          short_name: appName,
                          start_url: appUrl,
                          display: 'standalone',
                          background_color: '#ffffff',
                          theme_color: '#000000',
                          icons: [
                              {
                                  src: iconSrc,
                                  sizes: '144x144',
                                  type: iconType
                              }
                          ]
                      };
                      event.respondWith(
                          new Response(JSON.stringify(manifest), {
                              headers: { 'Content-Type': 'application/json' }
                          })
                      );
                  }
              });
            `;

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installAppBtn.disabled = false;
                readyView.querySelector('p').textContent = "Your app will be installed using this browser's profile, preserving your logins and cookies.";
            });

            createAppBtn.addEventListener('click', async () => {
                const appName = appNameInput.value.trim();
                const appUrl = appUrlInput.value.trim();

                if (!appName || !appUrl) {
                    alert('Please provide both an App Name and a URL.');
                    return;
                }

                initialView.classList.add('hidden');
                readyView.classList.remove('hidden');
                installAppBtn.textContent = 'Install "' + appName + '"';
                installAppBtn.disabled = true;
                readyView.querySelector('p').textContent = "Preparing your app... The install button will enable shortly.";

                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for(let registration of registrations) {
                        await registration.unregister();
                    }

                    const blob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);
                    const registration = await navigator.serviceWorker.register(swUrl);

                    await navigator.serviceWorker.ready;

                    if (registration.active) {
                        registration.active.postMessage({
                            type: 'REGISTER_PWA',
                            appName,
                            appUrl,
                            iconUrl: selectedIconUrl
                        });
                    }
                } catch (error) {
                    console.error('Error during PWA creation:', error);
                    alert('Failed to create the app. Please ensure your browser supports this feature and you are not in private mode.');
                    readyView.classList.add('hidden');
                    initialView.classList.remove('hidden');
                }
            });

            installAppBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    await deferredPrompt.userChoice;
                    deferredPrompt = null;
                }
            });
        });
    </script>

</body>
</html>
